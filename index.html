<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  
  <link rel="stylesheet" href="style.css">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
</head>

<body>
  
  <div class="accoun-create-page">
    
  </div>
  
  <div class="main-ui">
    <div class="main-page-header">
      <div class="main-header-top">
        <div class="header-menu">
          <i class='bx bx-menu' ></i>
        </div>
        <h4>Udow Chat</h4>
      </div>
      <div class="main-header-bottom">
        <p>Waiting for a network...</p>
      </div>
    </div>
    <div class="search-input">
      <i class='bx bx-search' ></i>
      <input type="text" placeholder="Search">
    </div>
    <div class="all-user-chat-box">
      <div class="user-chat">
        <span class="user-profile"></span>
        <div class="usrNam-and-msg-content">
          <h4>User Name</h4>
          <p>message content</p>
        </div>
      </div>
    </div>
  </div>
  
  
  
  <div class="chat-page">
    <div class="header">
    <i id="chatBack" class='bx bx-arrow-back'></i>
    <div class="profile"></div>
    <div class="userName">
      <h4>User Name</h4>
      <p>Online</p>
    </div>
    <div class="featere">
      <i class='bx bxs-phone' ></i>
      <i class='bx bxs-video' ></i>
      <i class='bx bxs-info-circle'></i>
    </div>
  </div>
  <div id="messages">
    <!-- Messages will be dynamically added here -->
    
  </div>

  <div class="input-container" id="sendMsg">
    <input type="text" id="msgTxt" placeholder="Message">
    <button type="submit" id="msgBtn" onclick="module.sendMsg()"><i class='bx bxs-send'></i></button>
  </div>
  </div>

  <script>
    module = {};
  </script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getDatabase, ref, set, remove, onChildAdded, onChildRemoved, update, onChildChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC0z5oWyCeyWrMYJfyeeFJPfhi5UnexryQ",
    authDomain: "chat-app-89ca7.firebaseapp.com",
    databaseURL: "https://chat-app-89ca7-default-rtdb.firebaseio.com",
    projectId: "chat-app-89ca7",
    storageBucket: "chat-app-89ca7.appspot.com",
    messagingSenderId: "569455246967",
    appId: "1:569455246967:web:f231e740ff03e89bb35072"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Function to initialize sender
  function initializeSender() {
    var storedSender = localStorage.getItem('sender');
    if (storedSender) {
      return storedSender;
    } else {
      let name = prompt('PLEASE ENTER YOUR NAME');
      while (!name) {
        name = prompt('Name cannot be empty. PLEASE ENTER YOUR NAME');
      }
      localStorage.setItem('sender', name);
      return name;
    }
  }

  // Initialize sender
  var sender = initializeSender();

  // Function to handle clearing the name from localStorage
  function clearNameFromLocalStorage() {
    localStorage.removeItem('sender');
    // Reload the page to trigger prompt again
    location.reload();
  }

  // Add event listener to the element with class 'header-menu'
  document.querySelector('.header-menu').addEventListener('click', clearNameFromLocalStorage);

  // Function to update typing status
  function updateTypingStatus(isTyping) {
    set(ref(db, `typing/${sender}`), {
      isTyping: isTyping
    });
  }

  // Detect when the user is typing
  msgTxt.addEventListener('input', () => {
    updateTypingStatus(msgTxt.value.length > 0);
  });

  // Function to scroll to the bottom of the messages container
  function scrollToBottom() {
    const messages = document.getElementById('messages');
    messages.scrollTop = messages.scrollHeight;
  }

  // TO SEND MESSAGES
  module.sendMsg = function sendMsg() {
    if (!sender) {
      sender = initializeSender();
      return; // Exit if sender is not defined
    }

    var msg = msgTxt.value;
    var timestamp = new Date().getTime();

    // Initially set status as "Sending..."
    set(ref(db, "messages/" + timestamp), {
      msg: msg,
      sender: sender,
      time: timestamp,
      seen: false
    }).then(() => {
      // Update the message status to "Sent" once it's confirmed to be added
      update(ref(db, "messages/" + timestamp), {
        status: "Sent"
      });
      // Clear typing status
      updateTypingStatus(false);
    }).catch((error) => {
      console.error("Error sending message:", error);
    });

    msgTxt.value = "";
  }

  // TO RECEIVE MSG
onChildAdded(ref(db, "messages"), (data) => {
  const messageData = data.val();
  let statusText = messageData.status || "Sending...";

  if (messageData.seen) {
    statusText = "Seen";
  }

  if (messageData.sender == sender) {
    messages.innerHTML += `<div style="justify-content:end" class="outer" id="${data.key}">
      <div id="inner" class="me">${messageData.msg}
      <button id="dltMsg" onclick="module.dltMsg('${data.key}')"><i class='bx bxs-trash'></i></button>
      </div> <span class="msgStatus ${messageData.seen ? "seen-status" : ""}" id="status-${data.key}">${statusText}</span></div><br>`;
  } else {
    messages.innerHTML += `<div class="outer" id="${data.key}" onclick="module.markAsSeen('${data.key}')">
      <div id="inner" class="notMe">${messageData.sender} : ${messageData.msg}</div></div>`;
    
    // Automatically mark the message as seen if it's not already seen
    if (!messageData.seen) {
      update(ref(db, "messages/" + data.key), {
        seen: true
      });
    }
  }

  // Scroll to the bottom after adding a new message
  scrollToBottom();
});

// TO UPDATE MSG STATUS
onChildChanged(ref(db, "messages"), (data) => {
  const messageData = data.val();
  const statusElement = document.getElementById(`status-${data.key}`);

  if (statusElement) {
    if (messageData.sender == sender) {
      statusElement.textContent = messageData.seen ? "Seen" : "Sent";

      // Add class to change the color if the message is seen
      if (messageData.seen) {
        statusElement.classList.add("seen-status");
      } else {
        statusElement.classList.remove("seen-status");
      }
    } else if (messageData.sender == sender && !messageData.status) {
      statusElement.textContent = "Sending...";
      statusElement.classList.remove("seen-status");
    }
  }
});

  // TO DELETE MSG
  module.dltMsg = function dltMsg(key) {
    remove(ref(db, "messages/" + key));
  }

  // WHEN MSG IS DELETED
  onChildRemoved(ref(db, "messages"), (data) => {
    var msgBox = document.getElementById(data.key);
    messages.removeChild(msgBox);
  });

  // MARK MESSAGE AS SEEN
  module.markAsSeen = function markAsSeen(key) {
    update(ref(db, "messages/" + key), {
      seen: true
    });
  }

  // Listen for typing status
  const typingRef = ref(db, 'typing');
  onChildAdded(typingRef, (data) => {
    const typingData = data.val();
    if (data.key !== sender && typingData.isTyping) {
      document.querySelector('.userName p').textContent = 'Typing...';
    }
  });

  onChildChanged(typingRef, (data) => {
    const typingData = data.val();
    if (data.key !== sender) {
      document.querySelector('.userName p').textContent = typingData.isTyping ? 'Typing...' : 'Online';
    }
  });

  onChildRemoved(typingRef, (data) => {
    if (data.key !== sender) {
      document.querySelector('.userName p').textContent = 'Online';
    }
  });
</script>
  <script src="script.js"></script>
</body>
</html>
